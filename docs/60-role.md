# Цели

* Ограничить доступ к админке и чувствительным действиям не просто `is_staff`, и **по ролям**.
* Упростить онбординг: «дал роль → доступ заработал».
* Подготовить базу под отчёты/финансы/контент без раздачи лишних прав.

# Предлагаемые роли (группы)

1. **Admins** — полный доступ (не обязательно суперюзер; superuser остаётся только техподдержке).
2. **Support** — просмотр пользователей, сброс пароля, просмотр рефералок, без прав изменения настроек/без удаления.
3. **Finance** — доступ к отчётам/экспорту, просмотр партнёрских начислений, без доступа к настройкам сайта и безопасности.
4. **Content** — управление текстами/страницами/новостями (на будущее), без юзеров/настроек.
5. **Admin-RO** (read-only admin) — «поглазеть», но ничего не менять.

# Матрица прав (сегодняшние модели)

| Роль     | User (view/change/delete) | SiteSetup (view/change) | Админка вход | Экспорт/отчёты |
| -------- | ------------------------- | ----------------------- | ------------ | -------------- |
| Admins   | v/c/d                     | v/c                     | да           | да             |
| Support  | v/c (без delete)          | v                       | да           | опц: да        |
| Finance  | v                         | —                       | да           | да             |
| Content  | —                         | —                       | опц: да      | —              |
| Admin-RO | v                         | v                       | да           | —              |

> Для «экспорт/отчёты» заведём отдельные **кастомные права** на будущее (см. ниже).

# Что сделать технически

1. **Группы и права — одна management-команда**
   Создать `manage.py init_roles` (или миграцию данных), которая:

   * создаёт группы `Admins`, `Support`, `Finance`, `Content`, `Admin-RO`;
   * назначает стандартные модельные права (add/change/delete/view) на `User`, `SiteSetup`;
   * добавляет **кастомные права** для «экспортов»/«финансов»:
     в `User.Meta.permissions = [("export_users", "Can export users"), ("view_finance", "Can view finance dashboards")]` и т.п.; команда назначает их нужным группам.

2. **Фильтр входа в админку по роли**
   Сейчас в админку пускает `is_staff` + OTP. Добавим требование членства в группе `Admins` **или** одной из «допущенных» ролей (Support/Finance/Admin-RO). Делается через переопределение `has_permission` у нашего `OTPAdminSite` **или** коротким middleware/декоратором на пути админки. Итог: случайный `is_staff=True` без роли — не попадёт.

3. **Шаблоны и навигация по разрешениям**

   * Для пунктов меню и кнопок используем `perms` (контекст-процессор Django уже есть):
     `{% if perms.app_main.view_user %}...{% endif %}` или по кастомным: `{% if perms.app_main.view_finance %}`.
   * Ссылку «Безопасность (2FA)» оставить только staff’у — уже так и есть.

4. **Админка: тонкая настройка ModelAdmin**

   * В `UserAdmin`/`SiteSetupAdmin` переопределить `has_view/change/delete_permission` так, чтобы, например, `Support` не видел кнопок удаления. Это даст «защиту от случайного клика» даже при наличии базовых прав.
   * Для `Admin-RO` вернуть False для `has_change_permission`/`has_delete_permission`.

5. **Декораторы/миксины для вьюх**

   * Для FBV: `@permission_required("app_main.view_finance")` и т.п.
   * Для CBV: `PermissionRequiredMixin` (`permission_required = ("app_main.view_finance",)`).
   * Если потребуется «роль как роль» (а не набор прав) — вводим небольшой хелпер `role_required("Finance")` (проверяет membership в группе).

6. **Онбординг персонала**

   * Маленькая форма/админ-экшен «Выдать роль» (или просто через админку групп).
   * Сигнал: если у сотрудника (`is_staff=True`) нет ни одной роли — подсветить в админке баннером.

7. **Аудит и безопасность**

   * Логи изменений групп/прав через стандартный `LogEntry` уже есть; при желании — отправлять в отдельный логгер.
   * Документация: кто и какие роли должен иметь; правило «в админку только через 2FA и с ролью».

# На будущее (когда пойдут деньги и статусы)

* **Object-level permissions** (не сейчас): если появятся сущности «заказы/выплаты», и нужно ограничить доступ по объектам/филиалам — тогда подключим `django-guardian` (пер-объектные права).
* **DRF/панели**: если появится API — сразу заложим `IsAuthenticated & DjangoModelPermissions`/кастомный `RolePermission`.
* **Экспорты**: вынести в отдельные admin-actions/csv выгрузки, прикрытые правом `export_users`/`export_finance`.

# Создать/обновить группы и права:
python manage.py init_roles

# Выдача роли сотруднику

Админка → Пользователи → выбрать пользователя → Группы → добавить Admins / Support / Finance / Content / Admin-RO.

# Где это реализовано

- Проверка допуска в админку (2FA + роли): swapers/admin.py (RoleBasedOTPAdminSite)
- Создание ролей и назначение прав: команда app_main.management.commands.init_roles
- Кастомные права: app_main/models.py → class User.Meta.permissions
- Использование прав и ролей в коде
- Проверка прав в шаблоне:

```py
{% if perms.app_main.view_finance %} ... {% endif %}
```

- Декоратор по роли (для FBV): @role_required("Finance") (см. app_main/authz.py)
- Для CBV: PermissionRequiredMixin/UserPassesTestMixin.

# Проблемы

- “You don’t have permission to access admin”:
- Проверь is_staff=True;
- Входит ли пользователь в одну из ролей;
- Пройдена ли 2FA (см. docs/50-2fa.md).