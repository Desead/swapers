# Документы сайта: как устроено и как пользоваться

## коротко

* Документы создаём в админке: **Документы → Добавить**.
* Редактор — **CKEditor 5**, мультиязычность — **django-parler** (чипы языков сверху формы).
* Поле **«Показывать на сайте»** выводит документ в меню и футере.
* Слаг генерится **автоматически** по заголовку выбранного языка (если оставить пустым).
* Безопасность: HTML из редактора **очищается** при рендере (санитайзер), поддержаны плейсхолдеры `[[DOMAIN]]`, `[[DOMAIN_VIEW]]`.
* Есть библиотека готовых шаблонов (**DocumentTemplate**, приложение `app_library`) — можно **вставить** содержимое шаблона в документ одним кликом (через форму).
* Фикстуры для шаблонов: `dumpdata` / `loaddata`, как подготовить и как перевести в **UTF-8** — ниже.

---

## Архитектура

### 1) Модель `Document` (приложение `app_main`)

* **Переводимые поля (Parler):** `title`, `slug`, `body`.
* **Служебные:** `show_in_site` (bool), `updated_at` (auto_now).
* **Слаг** уникален **в рамках языка**. Если оставить пустым — сгенерируется из `title` текущего языка.
* **Безопасность контента:** рендер идёт через метод `render_body()` → серверный санитайзер (удаляет `<script>`, JS-URLы и т.п.), затем выдаём в шаблон.

### 2) Шаблоны документов `DocumentTemplate` (приложение `app_library`)

* Предназначены для **быстрого старта**: «Правила обмена», «Политика конфиденциальности», «Пользовательское соглашение», «Риски / Отказ от ответственности», «Руководство по запросам от компетентных органов», «Политика AML / KYC», «FAQ».
* Поля: `title`, `body` (оба — **на русском**), `updated_at`.
* Использование: в форме документа выбрать шаблон и **сохранить** — текст выбранного шаблона **перенесётся** в документ (в текущее языковое представление).

### 3) Плейсхолдеры (подстановка домена)

* Поддерживаются маркеры в тексте:

  * `[[DOMAIN]]` — реальный домен из `SiteSetup.domain`;
  * `[[DOMAIN_VIEW]]` — «красивый» домен из `SiteSetup.domain_view`.
* Подстановка выполняется **на этапе рендера** (без порчи исходного текста документа).

---

## Как работать в админке

### Переключение языка

* Вверху формы документа есть **чипы языков** (как в `SiteSetup`):

  * Зелёный — для языка уже есть перевод;
  * Красный — перевода нет, можно создать;
  * Клик по чипу переключает вкладку и сохраняет «текущий язык формы».
* При **первом создании** документа — язык формы принудительно фиксируется на дефолтном (обычно `ru`), чтобы перевод не «улетал» в случайный `Accept-Language` браузера.

### Создание документа

1. Админка → **Документы → Добавить**.
2. Введите заголовок и текст (CKEditor 5) **на текущем языке** (подсвечен чип).
3. (Опционально) В поле **«Вставить из шаблона»** выберите шаблон → поставьте галочку **«Перезаписать содержимое шаблоном»** и **Сохраните**.

   * При создании: если выбран шаблон, заголовок/контент текущего языка **будут заменены** из шаблона.
   * При редактировании: замена произойдёт **только** если включён флаг «Перезаписать…».
4. Если **`slug` пуст** — он сгенерируется из `title` **в этом же языке**, будет уникальным в рамках языка.
5. Отметьте **«Показывать на сайте»**, если документ должен появиться в меню/футере.
6. Сохраните. Для других языков — переключитесь чипом и заполните перевод.

> ⚠️ Перевод сохраняется **отдельно для каждого языка**. Убедитесь, что редактируете нужный язык (активный чип).

### Где увидеть на фронте

* **Меню**: пункт «Документы» — выпадающий список (только `show_in_site=True`).
* **Футер**: под копирайтом список ссылок на документы (`show_in_site=True`).
* **Страница документа**: `/docs/<slug>/` — подбирается перевод выбранного языка сайта, если нет — фолбэк на русский.

---

## Безопасность контента

* **Санитайзер** применяется при рендере документа (на стороне сервера):

  * режет `<script>`, `javascript:`-ссылки, опасные атрибуты;
  * оставляет «безопасный» подмножество HTML (заголовки, абзацы, списки, ссылки, таблицы, базовое форматирование).
* Это значит: можно вставлять форматированный текст (в т.ч. из CKEditor), но вредоносный JS **не выполнится**.
* Плейсхолдеры домена (`[[DOMAIN]]`, `[[DOMAIN_VIEW]]`) подставляются **при рендере**, исходник остаётся «чистым».

---

## Шаблоны документов: наполнение и фикстуры

### Быстрый старт (готовый набор из репозитория)

Мы держим готовую фикстуру с русскими шаблонами в `app_library/fixtures/document_templates_ru_utf8.json`.
Загрузить:

```bash
python manage.py loaddata app_library/fixtures/document_templates_ru_utf8.json
```

### Как выгрузить свои шаблоны в фикстуру (на будущее)

1. Убедитесь, что БД мигрирована:

```bash
python manage.py migrate
```

2. Выгрузите только `DocumentTemplate`:

```bash
python manage.py dumpdata app_library.DocumentTemplate --indent 2 --output app_library/fixtures/document_templates_ru.json

```

3. Приведите файл к **UTF-8 без BOM** (Windows дружит не всегда). Надёжный способ — через Python:

```bash
python - <<'PY'
from pathlib import Path
p = Path("app_library/fixtures/document_templates_ru.json")
txt = p.read_bytes().decode("utf-8")  # упадёт, если не UTF-8
p.write_text(txt, encoding="utf-8")
print("Saved UTF-8 (no BOM)")
PY
```

> Альтернатива (PowerShell 7+):
> `Get-Content app_library/fixtures/document_templates_ru.json -Raw | Set-Content app_library/fixtures/document_templates_ru_utf8.json -Encoding utf8`

4. Проверьте загрузку:

```bash
python manage.py loaddata app_library/fixtures/document_templates_ru_utf8.json
```

### Как очистить таблицу шаблонов (перед загрузкой)

> Делайте это только если понимаете последствия.

Через shell:

```bash
python manage.py shell -c "from app_library.models_templates import DocumentTemplate; DocumentTemplate.objects.all().delete()"
```

И снова `loaddata` — как показано выше.

---

## Частые вопросы / диагностика

### «Unknown field(s) (title, body)…» в админке

В формах для Parler **нужно** использовать `TranslatableModelForm`. В нашем `DocumentAdminForm` это уже так. Если правили — верните:

```python
from parler.forms import TranslatableModelForm
class DocumentAdminForm(TranslatableModelForm):
    ...
```

### Слаг не появился

Оставляйте `slug` пустым — его сгенерит `save_model` из `title` **активного языка**. Если хотите другой — задайте вручную.

### Вставил `<script>` — не выполнилось (или показалось «как текст»)

Так и задумано: санитайзер убирает опасное. Отображается только «белый список» HTML-тегов и атрибутов.

### В меню/футере не вижу документ

Проверьте:

* в документе стоит **«Показывать на сайте»**;
* есть перевод для текущего языка; если нет — включён фолбэк на русский (он по умолчанию есть);
* нет конфликта по `slug` в этом языке.

---

## Технические детали (для разработчиков)

* **Админка**: `DocumentAdmin` (наследник `TranslatableAdmin` + наш миксин с языковыми чипами).
  В форме есть поля:

  * `template_to_insert` (ModelChoice для `DocumentTemplate`)
  * `template_overwrite` (флаг)
    При **сохранении**: если выбран шаблон — заголовок и тело **текущего языка** будут **заменены** на содержимое шаблона.

* **Рендер**: `document_view` подбирает перевод по текущему языку сайта; если перевода нет — берёт русский; тело идёт через `doc.render_body()` (санитайз + плейсхолдеры).

* **Навигация**: список документов в меню/футере — только `show_in_site=True`, язык — текущий/фолбэк.

---

## Команды, которые пригодятся

```bash
# Миграции
python manage.py makemigrations
python manage.py migrate

# Запуск
python manage.py runserver

# Создание суперпользователя (если нужно)
python manage.py createsuperuser

# Фикстуры шаблонов документов
python manage.py dumpdata app_library.DocumentTemplate --indent 2 > app_library/fixtures/document_templates_ru.json
python manage.py loaddata app_library/fixtures/document_templates_ru_utf8.json
```

---

Если захочется — могу положить этот текст в `docs/README_documents.md` и добавить удобные `make`/`powershell` сценарии для дампов/загрузок.
