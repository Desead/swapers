Вот удобная памятка по нашему **механизму блокировок входа (django-axes + наш «чёрный список»)**. Можешь просто сохранить это как `docs/security_axes.md`.

---

# Защита от перебора паролей и «чёрный список»

## Что это такое

* **django-axes** — ведёт счётчики неуспешных логинов и временно блокирует дальнейшие попытки по заданным ключам (логин+IP, только IP, только логин и т.п.).
* **Чёрный список (BlocklistEntry)** — наша модель, которая **мгновенно** запрещает вход для конкретного e-mail и/или IP без ожидания лимита.

Оба механизма работают одновременно: чёрный список срабатывает раньше (в мидлваре) и возвращает 403, а axes — при обработке формы логина.

---

## Как это выглядит в админке

### Попытки доступа (Axes → AccessAttempt)

Мы переопределили админку:

* Колонки: **IP**, **Логин**, **Неудач с начала**, **Тип блокировки** (`Логин + IP`, `IP`, `Логин`), **Заблокирован?**, путь, User-Agent.
* **Тип блокировки** и **Заблокирован?** вычисляются по **агрегированным** данным (не только по одной строке), с учётом «окна охлаждения».
* Экшены:

  * **Снять блокировку по IP**
  * **Снять блокировку по логину**
  * **Снять блокировку по логину+IP**

  Экшен выполнится **только** если запись реально заблокирована **именно этим** типом. Иначе запись пропускается (в сообщении видно «Снято N, пропущено M»).
* Стандартный экшен «Удалить выбранные» мы скрыли, чтобы случайным удалением не снимать блок.

> Примечание: колонку «Заблокирован до» мы не показываем — Axes не хранит это поле явно; время вычисляется из последней неудачной попытки + «окно охлаждения».

### Ошибки доступа (Axes → AccessFailureLog)

Лог событий — сюда попадают зафиксированные неудачные логины и причины блокировки. Удобно для аудита.

### Чёрный список (BlocklistEntry)

* Поля: пользователь (необязательно), **email**, **ip\_address**, **причина**, **активен?**
* Экшены: **Активировать** / **Деактивировать**.
* Если запись активна и совпал email **или** IP — вход мгновенно запрещается (403) с нашим шаблоном.

---

## Логика блокировок (как считает Axes)

* Счётчик ведётся по группам, определённым настройкой **AXES\_LOCKOUT\_PARAMETERS**:

  * чаще всего: `["username", "ip_address"]` и/или `"ip_address"`, `"username"`;
* После **AXES\_FAILURE\_LIMIT** неудачных попыток по такой группе включается блокировка на время **AXES\_COOLOFF\_TIME** (окно охлаждения).
* Когда «окно» истечёт, **следующая успешная авторизация** очищает соответствующие записи (старые строки попыток могут висеть, пока по этой группе снова никто не входит).

Примеры:

* Ввёл 5 раз неверный пароль с **одним логином** и **одного IP** → блок **логин+IP**.
* Ввёл 5 раз разные логины, но **с одного IP** → блок **IP**.
* Ввёл 5 раз один и тот же логин с разных IP → блок **логина**.

---

## Настройки (наш базовый профиль)

Ниже — типичный блок для `settings.py` (у нас уже подключено). Подстрой значения под проект:

```python
INSTALLED_APPS = [
    # ВАЖНО: сначала русифицированный Axes (наш AppConfig), затем наше приложение
    "app_main.apps.AxesRusConfig",
    "app_main.apps.AppMainConfig",
    # ...
]

MIDDLEWARE = [
    # Наша мидлвара чёрного списка должна стоять ДО аутентификации
    "app_main.middleware_blacklist.BlocklistMiddleware",
    # ...
    "axes.middleware.AxesMiddleware",
    # ...
]

# === Axes ===
AXES_ENABLED = True

# Лимит неудачных попыток до блокировки
AXES_FAILURE_LIMIT = 5

# Окно охлаждения (в течение этого времени после последней неудачи попытки блокируются)
from datetime import timedelta
AXES_COOLOFF_TIME = timedelta(minutes=15)

# По каким ключам считать блоки (порядок важен для «Тип блокировки»)
AXES_LOCKOUT_PARAMETERS = [
    ["username", "ip_address"],  # блок для конкретной пары логин+IP
    "ip_address",                # глобальный блок IP
    "username",                  # блок логина
]

# Совместимость с allauth: берем не только «чисто пользовательские» фейлы
AXES_ONLY_USER_FAILURES = False

# Поле формы логина при allauth
AXES_USERNAME_FORM_FIELD = "login"

# Что возвращать при блоке: 403 по умолчанию; можно настроить страничку
# AXES_LOCKOUT_TEMPLATE = "security/axes_lockout.html"  # если хочешь явно указать свой шаблон
# AXES_LOCKOUT_URL = "/ru/accounts/login/"              # либо редирект на URL (по желанию)

# При успешном входе сбрасывать счётчик
AXES_RESET_ON_SUCCESS = True

# Логирование
AXES_LOGGER = "axes.watch_login"
AXES_VERBOSE = True
```

Дополнительно (опционально, смотри по потребности):

* `AXES_ONLY_ADMIN_SITE = False` — если True, то защита действует только на `/admin/`.
* `AXES_NEVER_LOCKOUT_WHITELIST` / `AXES_NEVER_LOCKOUT_USERNAMES` / `AXES_NEVER_LOCKOUT_IP_ADDRESSES` — белые списки.
* `AXES_CLIENT_IP_METHOD` — откуда брать IP (например, из `X-Forwarded-For`, если есть прокси).
* `AXES_LOCKOUT_CALLABLE` — кастомная функция «заблокирован ли пользователь» (редко нужно).

---

## Как пользоваться (сценарии)

### Заблокировать вручную

**На время (через Axes):**

1. В админке → «Попытки доступа».
2. Найди запись на нужный логин/IP.
3. Нажми подходящий экшен:
   — «Снять блокировку …» используется для **снятия**.
   Чтобы **включить** блок, Axes должен сам набрать лимит (это анти-брутфорс, а не ручной бан).

Обычно для ручного бана лучше использовать чёрный список.

**Навсегда / до ручной отмены (через чёрный список):**

1. Админка → «Чёрный список».
2. Создай запись: e-mail и/или IP, причина, «активен».
3. С этого момента вход **сразу** будет 403 (без лимита).

### Разблокировать

* **По IP / логину / логин+IP:** в «Попытках доступа» выделяешь записи и жмёшь соответствующий экшен. Если тип не совпадает — запись будет пропущена (видно в сообщении).
* **Чёрный список:** просто деактивируй запись (или удали её).

### Что увидит пользователь

* При блоке Axes (перебор паролей) — наша страница «учётная запись заблокирована» (расширяет `base.html`).
* При чёрном списке — 403 с нашим шаблоном «Доступ запрещён».

> Если вместо 403 иногда видишь «200 с ошибкой формы»: так ведёт себя связка allauth+axes на некоторых настройках. Мы это учли и тестами, и колонкой «Заблокирован?».

---

## Тесты, на которые можно ориентироваться

* Блок после N неудачных попыток и последующий успех после сброса.
* Сброс по логину позволяет войти.
* Сброс по IP позволяет войти.
* Чёрный список по e-mail блокирует вход.
* Чёрный список по IP блокирует вход.

---

## Программный сброс (если нужно в коде)

```python
# Внимание: в разных версиях Axes сигнатура reset(...) отличается (ip vs ip_address).
# У нас в админке уже есть совместимая обёртка; если нужно отдельно:
from axes.utils import reset as axes_reset

# Пробуем по логину:
axes_reset(username="user@example.com")

# Пробуем по IP (в вашей версии может быть ip=..., а не ip_address=...):
try:
    axes_reset(ip="127.0.0.1")  # или ip_address="127.0.0.1"
except TypeError:
    axes_reset(ip_address="127.0.0.1")
```

---

## Частые вопросы

**Почему колонка «Заблокирован до» отсутствует?**
Axes не хранит явного поля «до какого времени». Блок определяется по «последняя неудача + окно охлаждения». Мы показываем только флаг «Заблокирован?» — он точный.

**Почему удаление попыток снимает блок?**
Потому что блок — это **сумма** неудач за «окно». Удалил строки → сумма упала ниже лимита. Поэтому мы спрятали массовое «Удалить» и добавили аккуратные экшены сброса.

**Чем отличается блок Axes от чёрного списка?**
Axes — временный, автоматический анти-брутфорс, завязан на лимиты и время. Чёрный список — мгновенный и действует, пока запись активна.

**Если я 5 раз ввёл разные логины с одного IP, почему «Тип блокировки = IP», а не «логин+IP»?**
Потому что нет единого логина, который бы «набрал» лимит. Сумма на уровне IP достигает порога — и включается блок «IP».

---

## Рекомендации по продакшену

* Проверить `AXES_CLIENT_IP_METHOD` и `SECURE_PROXY_SSL_HEADER`, если есть обратный прокси/балансировщик — IP должен определяться корректно.
* Заполнить белые списки для внутренних сервисов и/или админов.
* Логи Axes (WARN) отдать в централизованный логгер/алертинг.
* Подумать о captcha/доп.факторах на форме после нескольких фейлов (Axes не мешает).
* Периодически просматривать «Ошибки доступа» (Audit).

---

Если захочешь — добавлю короткую версию «для техподдержки» с чек-листом: *как понять, почему заблокирован, где смотреть, чем снимать*.
