# Очистка SVG-файлов в библиотеке баннеров

---

## Что и зачем

Мы принимаем баннеры партнёров через модель `app_library.BannerAsset`. Для безопасности загружаемые **SVG** автоматически «санитизируются» при сохранении, чтобы исключить XSS/HTML-инъекции через:

* скрипты и обработчики событий,
* опасные ссылки (`javascript:`, `data:`),
* внедрение HTML внутри SVG (`<foreignObject>`),
* потенциально опасные CSS-конструкции.

Растровые форматы (`jpg`, `jpeg`, `png`, `gif`) не трогаются.

Плюс действует ограничение размера файла — **до 1 МБ**.

---

## Где реализовано

Файл: `app_library/models.py`, модель: `BannerAsset`.

Ключевые элементы:

* Валидатор размера: `validate_banner_filesize` (1 МБ).
* Санитайзер: `_sanitize_svg_bytes(data: bytes)`.
* Перехват в `BannerAsset.save(...)` — для `.svg` файл читается, очищается и **перезаписывается** безопасной версией перед сохранением.


---

## Что именно вырезается из SVG

Санитайзер удаляет:

* `<?xml …?>` и `<!DOCTYPE …>` декларации (не нужны и иногда используются для атак).
* Теги `<script>…</script>` и `<foreignObject>…</foreignObject>`.
* Все атрибуты обработчиков событий: `onload=`, `onclick=`, … (`on*`).
* Опасные ссылки в атрибутах `href`/`xlink:href` c `javascript:` и `data:`.
* Опасные инлайн-стили: `style="…url(…)"`, `expression(…)`, `-moz-binding:`.

Если файл **не** SVG — санитайзер пропускает без изменений.

---

## Как пользоваться (для админов и контента)

1. Зайдите в **Админка → Библиотека баннеров** (`BannerAsset`).
2. Загрузите файл (поддерживаются: `jpg`, `jpeg`, `png`, `gif`, `svg`), укажите название и тему (тёмный/светлый).
3. Сохраните.

   * Если это SVG, он автоматически «почистится».
   * Поле «Размер файла (байт)» обновится с учётом очищенного содержимого.
4. В моделях, которые используют баннеры (например, `Monitoring`), просто выбирайте необходимые `BannerAsset` из выпадающих списков.

---

## Проверка/контроль качества

### Быстрый ручной тест

1. Создайте SVG с чем-то «плохим», например:

   ```xml
   <svg xmlns="http://www.w3.org/2000/svg"><script>alert(1)</script><rect width="100" height="30"/></svg>
   ```
2. Загрузите как `BannerAsset`.
3. Откройте загруженный файл в браузере через `/media/…` и/или посмотрите его исходник (скачайте) — тега `<script>` уже быть не должно.

### Что будет, если файл слишком большой

При превышении лимита 1 МБ сохранение не произойдёт; в админке покажется ошибка валидатора:

> Максимальный размер файла — 1 МБ. Сейчас: X.Y МБ.

---

## Как это работает внутри (коротко)

* В `save()` модели `BannerAsset` для `.svg` файл читается в байты → прогоняется через `_sanitize_svg_bytes()` → при изменении контента записывается обратно в `self.file` через `ContentFile`, с `save=False` (чтобы не триггерить повторный `save()` модели) → далее обычный `super().save()`.
* Для остальных форматов лишь фиксируется `size_bytes`.

---

## Настройки и расширение

* **Изменить лимит** размера: поправьте константу `MAX_BANNER_MB` в `app_library/models.py`.
* **Разрешения форматов**: список в `FileExtensionValidator(allowed_extensions=[…])`.
* **Усилить политику**: можно дополнительно запрещать любые `url()` в стилях, все `data:`-ресурсы, или вовсе вычищать атрибут `style`. Для более строгих требований рассмотрите перенос на «белый список» тегов/атрибутов (например, через парсинг и сборку чистого DOM).

---

## Взаимодействие с CSP

Мы уже применяем строгую CSP. Санитайзер SVG — это **дополнительный** уровень защиты на сервере. Даже если SVG попадёт в страницу, в нём не останется активных скриптов/обработчиков.

---

## Ограничения и рекомендации

* Санитайзер лёгкий и эвристический (регексы). Он закрывает типовые векторы (скрипты, обработчики, опасные ссылки/стили), но не является полноценным XML-парсером с белыми списками. Для высокорискованных сценариев можно ужесточить правила.
* Не удаляет «художества» (графику), стремится затронуть только опасные конструкции.
* На производительность влияние минимально, т.к. SVG обычно небольшие.

---

## FAQ

**Нужно ли что-то включать?**
Нет. Работает «из коробки» при сохранении `BannerAsset`.

**Портится ли вид баннера?**
Графика и безопасные атрибуты не трогаются. Если баннер пытался использовать скрипты/инлайн-обработчики — они будут удалены.

**Почему не вырезаем всё подряд?**
Балансируем безопасность и совместимость. По умолчанию закрываем типовые атакующие конструкции. Если нужно жёстче — расширяйте правила.

---
